<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/xi-editor-gatsby/app.ec722e89715d1f3f20eb.css"></style><style data-href="/xi-editor-gatsby/1.4f2336f9c70ba658fd59.css">/*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}strong{font-weight:bolder}img{border-style:none}button,input{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible}button{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}legend{color:inherit;display:table;max-width:100%;white-space:normal}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[hidden]{display:none}html{box-sizing:border-box;font-family:sans-serif}*,:after,:before{box-sizing:inherit}h1,h2,h3,h4,p{margin:0}button{background:transparent;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{margin:0}*,:after,:before{border:0 solid #dae1e7}img{border-style:solid;max-width:100%;height:auto}input::-webkit-input-placeholder{color:inherit;opacity:.5}input::-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}.container{width:100%}@media (min-width:576px){.container{max-width:576px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:992px){.container{max-width:992px}}@media (min-width:1200px){.container{max-width:1200px}}.list-reset{list-style:none;padding:0}.bg-xi-blue{background-color:#607d8b}.bg-xi-blue-dark{background-color:#34515e}.bg-blue-light{background-color:#6cb2eb}.bg-blue-lightest{background-color:#eff8ff}.hover\:bg-blue-lighter:hover{background-color:#bcdefa}.hover\:bg-blue-lightest:hover{background-color:#eff8ff}.border-transparent{border-color:transparent}.border-xi-blue{border-color:#607d8b}.border-xi-blue-dark{border-color:#34515e}.border-green,.hover\:border-green:hover{border-color:#38c172}.focus\:border-grey-light:focus{border-color:#dae1e7}.rounded{border-radius:.25rem}.rounded-r{border-top-right-radius:.25rem;border-bottom-right-radius:.25rem}.rounded-l{border-top-left-radius:.25rem;border-bottom-left-radius:.25rem}.border{border-width:1px}.border-t-4{border-top-width:4px}.border-b-4{border-bottom-width:4px}.border-t{border-top-width:1px}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.inline-flex{display:inline-flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.items-stretch{align-items:stretch}.justify-between{justify-content:space-between}.flex-1{flex:1 1 0%}.flex-no-shrink{flex-shrink:0}.font-sans{font-family:system-ui,BlinkMacSystemFont,-apple-system,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif}.font-thin{font-weight:200}.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}.h-4{height:1rem}.h-full{height:100%}.leading-tight{line-height:1.25}.leading-normal{line-height:1.5}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-4{margin-left:1rem;margin-right:1rem}.my-8{margin-top:2rem;margin-bottom:2rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-2{margin-top:.5rem}.mb-2{margin-bottom:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-4{margin-bottom:1rem}.ml-4{margin-left:1rem}.mt-8{margin-top:2rem}.mr-8{margin-right:2rem}.mb-8{margin-bottom:2rem}.mb-32{margin-bottom:8rem}.max-w-sm{max-width:30rem}.-ml-2{margin-left:-.5rem}.-ml-8{margin-left:-2rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pl-4{padding-left:1rem}.pb-6{padding-bottom:1.5rem}.pt-8{padding-top:2rem}.pr-10{padding-right:2.5rem}.pb-10{padding-bottom:2.5rem}.absolute{position:absolute}.pin-t{top:0}.pin-r{right:0}.pin-b{bottom:0}.fill-current{fill:currentColor}.text-xi-blue{color:#607d8b}.text-xi-blue-dark{color:#34515e}.text-grey-darkest{color:#3d4852}.text-grey-dark{color:#8795a1}.text-white{color:#fff}.text-blue-darkest{color:#12283a}.text-blue-darker{color:#1c3d5a}.hover\:text-xi-blue:hover{color:#607d8b}.hover\:text-blue-dark:hover{color:#2779bd}.hover\:text-blue-light:hover{color:#6cb2eb}.text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-base{font-size:1rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-4xl{font-size:2.25rem}.italic{font-style:italic}.uppercase{text-transform:uppercase}.underline{text-decoration:underline}.no-underline{text-decoration:none}.hover\:underline:hover{text-decoration:underline}.w-4{width:1rem}.w-8{width:2rem}.w-24{width:6rem}.w-2\/5{width:40%}.w-3\/5{width:60%}.w-1\/6{width:16.66667%}.w-full{width:100%}#___gatsby,#___gatsby>div,body,html{width:100%;height:100%}@media (min-width:768px){.md\:mx-0{margin-left:0;margin-right:0}.md\:mt-0{margin-top:0}.md\:ml-0{margin-left:0}.md\:relative{position:relative}}@media (min-width:992px){.lg\:flex{display:flex}.lg\:ml-0{margin-left:0}.lg\:w-3\/4{width:75%}}@media (min-width:1200px){.xl\:w-4\/5{width:80%}}</style><meta name="generator" content="Gatsby 2.0.66"/><style data-emotion-css="mz9jeh">.css-mz9jeh *{color:rgba(0,0,0,0.87);}.css-mz9jeh > p{display:block !important;-webkit-box-pack:start;-webkit-justify-content:start;-ms-flex-pack:start;justify-content:start;color:#462a16;margin-top:1rem;margin-bottom:2rem;font-size:1.125rem;line-height:1.5;}.css-mz9jeh > h2{color:#f6993f;}.css-mz9jeh > h2,.css-mz9jeh > h3,.css-mz9jeh > h4{margin-top:2rem;margin-bottom:1rem;color:#34515e;}.css-mz9jeh > p > img{max-width:20rem;}.css-mz9jeh ul{margin-left:2rem;padding:0;}.css-mz9jeh ul > li{margin-top:0.8rem;margin-bottom:0.8rem;}</style><title data-react-helmet="true"> Xi-Editor | Documentation</title><link data-react-helmet="true" rel="icon" type="image/png" href="/xi-editor-gatsby/img/logo.png" sizes="16x16"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><meta data-react-helmet="true" name="description" content="Plugin architecture"/><link rel="manifest" href="/xi-editor-gatsby/manifest.webmanifest"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="sitemap" type="application/xml" href="/xi-editor-gatsby/sitemap.xml"/><link as="script" rel="preload" href="/xi-editor-gatsby/component---src-templates-documentation-post-js-bf4b84082dcc787cf128.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/1-cfa0b987dfef8a0ec785.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/0-cf69331c20fe9b368446.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/app-0f19a3d51a450902d8f3.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/webpack-runtime-d861f76e7d4d64f763c6.js"/><link rel="preload" href="/xi-editor-gatsby/static/d/751/path---documentation-plugin-c-9-b-a96-d9zvTxhENLVQug4WNLE1ReAhc.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="h-full w-full flex flex-col items-stretch font-sans"><header class="flex flex-col flex-no-shrink"><div class="bg-xi-blue-dark"><div class="container mx-auto"><div class="flex justify-between items-center py-4"><div class="flex items-center"><a class="text-white no-underline flex items-center" href="/xi-editor-gatsby/"><img src="/img/logo.png" alt="logo" class="w-8"/></a><p class="ml-4 font-thin text-xl text-white">Xi-Editor</p></div><div><div class="flex absolute pin-t pin-r mt-4 mr-4 md:mt-0 md:relative"><input type="text" id="search" autoComplete="off" class="w-full py-2 text-grey-darkest pl-4 pr-10 rounded focus:border-grey-light" placeholder="Search..."/><div class="flex items-center"><svg class="fill-current text-grey-dark inline-block h-4 w-4 -ml-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.9 14.32a8 8 0 1 1 1.41-1.41l5.35 5.33-1.42 1.42-5.33-5.34zM8 14A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"></path></svg></div></div></div></div></div></div><div class="bg-xi-blue"><div class="container mx-auto"><div class="flex justify-between items-center"><div class="-ml-2 pt-2"><a class="inline-block no-underline text-base uppercase text-white font-semibold py-4 px-6 border-b-4 border-transparent hover:border-green" href="/xi-editor-gatsby/">home</a><a class="inline-block no-underline text-base uppercase text-white font-semibold py-4 px-6 border-b-4 border-transparent hover:border-green" href="/xi-editor-gatsby/documentation/config">docs</a><a class="inline-block no-underline text-base uppercase text-white font-semibold py-4 px-6 border-b-4 border-transparent hover:border-green" href="/xi-editor-gatsby/gsoc/gsoc">gsoc</a><a class="inline-block no-underline text-base uppercase text-white font-semibold py-4 px-6 border-b-4 border-transparent hover:border-green" href="/xi-editor-gatsby/contribute">contribute</a><a class="inline-block no-underline text-base uppercase text-white font-semibold py-4 px-6 border-b-4 border-transparent hover:border-green" href="/xi-editor-gatsby/building-docs">buildind docs</a><a class="inline-block no-underline text-base uppercase text-white font-semibold py-4 px-6 border-b-4 border-transparent hover:border-green" href="/xi-editor-gatsby/blog">blog</a></div></div></div></div></header><main role="main" class="flex-1 "><div class="flex"><div class="w-1/6 h-full flex-no-shrink"><ul class="list-reset p-4 flex flex-col"><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/frontend-notes/">Notes on writing front-ends</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/frontend-protocol/">The Frontend Protocol</a><a aria-current="page" class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm bg-blue-lightest border" href="/xi-editor-gatsby/documentation/plugin/">Plugin architecture</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/config/">Working with the config system</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/crdt/">CRDT - An approach to async plugins and undo</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/crdt-details/">CRDT - The Xi Text Engine</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/fuchsia-ledger-crdts/">CRDT - Using the Ledger for CRDTs</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-00/">Rope science - Introduction</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-01/">Rope science, part 1 - MapReduce for text</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-02/">Rope science, part 2 - metrics</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-03/">Rope science, part 3 - Grapheme cluster boundaries</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-04/">Rope science, part 4 - parenthesis matching</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-05/">Rope science, part 5 - incremental word wrapping</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-06/">Rope science, part 6 - parallel and asynchronous word wrapping</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-08/">Rope science, part 8 - CRDTs for concurrent editing</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-08a/">Rope science, part 8a - CRDT follow-up</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-09/">Rope science, part 9 - CRDT Approach to Async Plugins and Undo</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-10/">Rope science, part 10 - designing for a conflict-free world</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-11/">Rope science, part 11 - practical syntax highlighting</a><a class="no-underline text-xi-blue-dark p-2 hover:bg-blue-lightest text-sm" href="/xi-editor-gatsby/documentation/rope-science-12/">Rope science, part 12 - minimal invalidation</a></ul></div><div class="flex-1 flex-wrap mb-32"><section class="lg:flex h-full"><div class="lg:w-3/4 xl:w-4/5"><h1 class="ml-4 lg:ml-0 text-xi-blue-dark mt-8 mb-4">Plugin architecture</h1><div class="ml-4 lg:ml-0 css-mz9jeh ekxoq9d0"><p><strong>Note:</strong> This document is mostly of historical interest. Although the
high level details remain true, implementation details have changed,
and remain in flux.</p>
<h2 id="philosophy"><a href="#philosophy" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Philosophy</h2>
<p>All serious programming editors have a mechanism for extensibility,
often in the form of plugins, also often in terms of a scripting
language with bindings to editor objects.</p>
<p>Xi follows the philosophy that plugins should be asynchronous, and it
should be possible to write them in any language. Thus, plugins are
invoked through RPC, and no language bindings are provided inside the
front-end or back-end process. A slow plugin should not interfere with
typing or other editing operations, and a crashing plugin should not
lead to data loss.</p>
<p>The idea of asynchrony is appealing, but actually implementing it is
challenging. The fundamental problem is that the plugin may provide
edits (for example, inserting indentation in a language auto-indent
mode) that happen at the same time as additional edits by the user.
These edits must be reconciled somehow. In some cases, specificially
where the user edits are to the text and not the rich-text annotations,
and the plugin edits are to the annotations but not the text (as will
often be the case for syntax highlighting), there is no fundamental
conflict and the overall system will eventually converge. (In this
case, it converges to the same state as running the plugin in batch
mode over the text input, and this should be taken as a correctness
criterion for plugins that do incremental computation). In xi, I plan
to address the challenge of parallel edits head-on, using some form
of operational transforms or differential synchronization. One
potential advantage of this approach is that it may make collaborative
editing practical.</p>
<p>In xi, not everything is a plugin. Even though the front-end to
back-end communication is similarly mediated by RPC, the protocol is
quite different.</p>
<p>It is expected that most plugins will be written on top of a
convenience library. This library will provide caching for access to
buffer contents, and in general abstract away low-level details of the
RPC protocol. Even so, it should stay small and simple, so it is
practical to provide for a number of languages. Initially, I will
probably develop the plugin protocol and library using Python for
rapid iteration, and then do Go and Rust, for higher performance.</p>
<p>Xi will not provide a package manager, but rather will defer to
existing mechanisms. Using, for example, apt-get, brew, or chocolatey
to install plugins should work well. Alternatively, others may choose
to package a <em>distribution</em> containing the xi editor (front-end and
back-end) along with a curated collection of plugins, as, for example,
<a href="https://www.continuum.io/downloads">Anaconda</a> does for IPython.</p>
<h2 id="basic-architecture"><a href="#basic-architecture" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Basic architecture</h2>
<h3 id="invocation-config-files"><a href="#invocation-config-files" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Invocation; config files</h3>
<p>Deciding when to invoke a plugin, and how, is non-trivial. This starts
with a configuration file, which represents a <em>trigger</em> of when to
invoke the plugin, as well as a path to the plugin and some options. A
trigger can be a keyboard and/or menu command, a programming language
(so basically a selector based on file extension), or hooks for other
events (an example would be running gofmt before every save).</p>
<p>There are three levels of invocation: one-shot, per-buffer, and
editor-global. In a one-shot invocation, the editor starts the child
process, performs the RPC, and shuts down the process when the RPC
is complete. In per-buffer invocation, the process stays open for the
life of the buffer. If more than one buffer requires the use of a
plugin, xi will invoke multiple instances. In editor-global, a single
process is expected to accept RPCs involving multiple buffers, and
RPC requests are annotated with the buffer id.</p>
<p>The config file also indicates the protocol version expected by the
plugin, and xi will attempt to conform to a range of versions in
actual use.</p>
<p>Loading plugin info potentially has huge impact on startup time. Xi
will load all config files at startup, but will attempt to defer
executing the plugin binaries. Thus, the format of the config files
needs to be quick to parse. I am leaning toward TOML as providing a
good balance. (YAML is an alternative, I'm considering it because it's
required to process new-format
<a href="https://www.sublimetext.com/docs/3/syntax.html">Sublime Text syntax definitions</a>.)</p>
<p>For developing plugins, the config file can direct the plugin to be
compiled at invocation time ("go run" or "cargo run", for example).
This mechanism should not be used for publishing plugins and
distributing them to users.</p>
<p>I'm thinking that config files will be able to to "include" another
one. This would be the preferred way to handle optional plugins; they
would be stored in a directory that would not by default get processed
on editor startup, but a config file in a user-editable space can
point to another one.</p>
<h3 id="read-access-to-the-buffer"><a href="#read-access-to-the-buffer" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Read access to the buffer</h3>
<p>When attaching a buffer (ie, on startup of one-shot or per-buffer
plugins), xi starts by sending a one-megabyte window of the buffer,
centered around the cursor. The plugin may request additional
substrings of the buffer through RPC. Note that such requests access
a <em>snapshot</em> of the buffer, even if the user is concurrently editing.
As mentioned above, buffer access is one of the functions provided by
a convenience library - the actual plugin logic should be able to
request an arbitrary substring, or iterate through all lines, and have
that served by cache and RPC on cache miss.</p>
<p>When the RPC to the plugin completes, the snapshot is released. Any
edits to the buffer are then sent as <em>deltas</em> to all plugins
subscribing to that buffer. Again, a major function of the convenience
library is to apply these deltas. The deltas may also, of course,
trigger computation, such as reapplying syntax coloring.</p>
<h3 id="write-access-to-the-buffer"><a href="#write-access-to-the-buffer" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Write access to the buffer</h3>
<p>The plugin can also send deltas back to the core, either in the course
of RPC processing or spontaneously. These deltas can be to the text
buffer (for example, for indentation and electric brackets) and as
rich text spans (for syntax highlighting).</p>
<p>These deltas are suggestions; the core may need to reconcile them with
other edits, and may possibly discard them. Xi will communicate back
to the plugin to indicate whether the delta was accepted as-is or
modified. A sophisticated plugin may attempt to retry, based on more
up-to-date information about edits to the buffer. This seems like a
reasonable approach to implementing differential synchronization.</p>
<p>Other responses from the plugin are expected to include:</p>
<ul>
<li>
<p>Populating a completion menu.</p>
</li>
<li>
<p>Displaying status messages.</p>
</li>
<li>
<p>Popping up modal dialogs?</p>
</li>
<li>
<p>What else?</p>
</li>
</ul>
<h3 id="asynchrony-modes"><a href="#asynchrony-modes" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Asynchrony modes</h3>
<p>Three asynchrony modes are anticipated. I might not implement all of
them.</p>
<p>In synchronous mode, additional edits to the buffer are blocked until
the RPC to the plugin completes. Thus, the deltas produced by the
plugin are applied as-is, with no possibility of conflicts from
concurrent edits. This is the simplest mode, but discouraged because
it can cause typing lag.</p>
<p>The normal mode is described above. During the life of an RPC, the
plugin operates on a read-only snapshot of the buffer. No further
deltas are sent to the plugin until the RPC completes. At that point,
the xi core merges any resulting deltas with the other concurrent
edits, and sends the plugin a notification of how the deltas were
resolved. In this mode, much of the asychnronous nature is hidden from
plugins; simple plugins can simply trust the core to reconcile the
deltas correctly, and take no further action</p>
<p>In fully asynchronous mode, deltas are sent from the core to the
plugin as soon as editing operations are made. My current thinking is
that each delta introduces a "generation number," and that queries
to retrieve buffer contents reference a specific generation number.</p>
<p>The distinction between normal and fully asychronous modes may be
implemented simply as a choice of what the plugin chooses to do with
delta notifications - if it batches them up until the RPC completes,
then it is effectively normal mode. This also seems like a good
function for the convenience library. Synchronous mode, however,
requires explicit cooperation from the editor, to prevent concurrent
edits while an RPC is in flight.</p>
<h2 id="security"><a href="#security" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security</h2>
<p>Plugins can potentially</p>
<h2 id="open-questions"><a href="#open-questions" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Open questions</h2>
<p>The state of the art technique for syntax highlighting is to store an
explicit highlighting state at the beginning of each line (in general,
this state consists of a stack of begin/end nested rules; it is in
theory unbounded but in practice will take on a small number
of values). The fundamental syntax highlighting step, then, is a
function that takes the line state and the text of a line, and
produces a set of rich text spans for the line, as well as the line
state for the beginning of the next line.</p>
<p>A large part of the convenience library will be geared to efficient
incremental computation based on these primitives. A key observation
is that, when processing a delta, if you reach the same line (after
the parts changed by the delta) in the same state, you can stop
processing; all subsequent highlighting will be untouched. Of course,
typing <code>/*</code> can cause a state change to cascade to the end of a
document (this is one reason many "electric" modes auto-insert a
closing <code>*/</code> to try to keep such things balanced).</p>
<p>The open question is: where should the state be stored? I'm leaning
to do it in the plugin, but a case can be made for letting the core
function as a "database" that can store this information efficiently
even for huge files. Note though, the state info can be considered a
cache, because it is always possible to reconstruct it by scanning
from the beginning of the buffer.</p>
<h3 id="additional-use-cases"><a href="#additional-use-cases" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Additional use cases</h3>
<p>Many of these use cases are ambitious, requiring sophisticated UI
wiring; they are unlikely to be implemented soon but might be worth
thinking about.</p>
<ul>
<li>
<p>Access to version control (maybe including display of diffs, or,
more ambitiously, providing UI to do interactive merging).</p>
</li>
<li>
<p>Embedding in a debugger (just annotating breakpoints and the like
should be fairly straightforward).</p>
</li>
<li>
<p>Source code navigation, including reference hierarchies.</p>
</li>
</ul>
<h2 id="references"><a href="#references" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>References</h2>
<h3 id="other-editors"><a href="#other-editors" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other editors</h3>
<ul>
<li>
<p><a href="https://github.com/neovim/neovim/wiki/Plugin-UI-architecture">Neovim</a>.
Asynchronous RPC-based. GUI front-ends are another form of plugin.</p>
</li>
<li>
<p><a href="http://www.sublimetext.com/docs/api-reference">Sublime Text</a>.
Basically exposes editor objects (views, windows, regions, etc)
through Python bindings.</p>
</li>
<li>
<p><a href="https://github.com/martanne/vis#lua-api-for-in-process-extension">Vis</a>.
Lua bindings for in-process extension, used for syntax highlighting
(which is also PEG-based).</p>
</li>
</ul>
<h3 id="editor-prototypes"><a href="#editor-prototypes" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Editor prototypes</h3>
<ul>
<li>
<p><a href="https://github.com/swiboe/swiboe#swiboe---">Swiboe</a>
("<strong>Swi</strong>tch<strong>bo</strong>ard <strong>e</strong>ditor"). Everything is a plugin.</p>
</li>
<li>
<p><a href="https://github.com/wi-ed/wi">Wi</a>. Fully asychronous, written in Go.</p>
</li>
</ul>
<h3 id="fundamental-technology"><a href="#fundamental-technology" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fundamental technology</h3>
<ul>
<li>
<p><a href="https://neil.fraser.name/writing/sync/">Differential Synchronization</a>.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Operational_transformation">Operational transformation</a>.</p>
</li>
<li>
<p><a href="http://www.jsonrpc.org/specification">JSON-RPC 2.0 Specification</a>.</p>
</li>
</ul></div></div></section></div></div></main><footer class="flex-no-shrink border-t pt-4 pb-10 w-full pt-8 px-8"><p class="text-xs text-xi-blue-dark">See the<!-- --> <a href="https://github.com/xi-editor/xi-editor" class="text-xi-blue-dark hover:text-xi-blue font-semibold">GitHub Project</a></p></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-documentation-post-js","jsonName":"documentation-plugin-c9b","path":"/documentation/plugin/"};window.dataPath="751/path---documentation-plugin-c-9-b-a96-d9zvTxhENLVQug4WNLE1ReAhc";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.ec722e89715d1f3f20eb.css","/app-0f19a3d51a450902d8f3.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-2c5a1e1634272d208170.js"],"component---src-templates-blog-list-js":["/component---src-templates-blog-list-js.4f2336f9c70ba658fd59.css","/component---src-templates-blog-list-js-dc3676bd46f72cae8137.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-0a03af28f982bc9a7684.js"],"component---src-templates-documentation-post-js":["/component---src-templates-documentation-post-js-bf4b84082dcc787cf128.js"],"component---src-templates-gsoc-template-js":["/component---src-templates-gsoc-template-js-0a9b295b999b5a269d0c.js"],"component---src-pages-404-js":["/component---src-pages-404-js.4f2336f9c70ba658fd59.css","/component---src-pages-404-js-eb2c574374af44aa0333.js"],"component---src-pages-building-docs-js":["/component---src-pages-building-docs-js-5b19d63c0acbb8c8f90b.js"],"component---src-pages-contribute-js":["/component---src-pages-contribute-js-b34dea3d2e0643b53e2b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-a8a76daa8b4e99eb5f1b.js"]};/*]]>*/</script><script src="/xi-editor-gatsby/webpack-runtime-d861f76e7d4d64f763c6.js" async=""></script><script src="/xi-editor-gatsby/app-0f19a3d51a450902d8f3.js" async=""></script><script src="/xi-editor-gatsby/0-cf69331c20fe9b368446.js" async=""></script><script src="/xi-editor-gatsby/1-cfa0b987dfef8a0ec785.js" async=""></script><script src="/xi-editor-gatsby/component---src-templates-documentation-post-js-bf4b84082dcc787cf128.js" async=""></script></body></html>