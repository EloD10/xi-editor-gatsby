<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/xi-editor-gatsby/1.d39ed622b78079570519.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}strong{font-weight:bolder}code{font-family:monospace,monospace;font-size:1em}img{border-style:none}button,input{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible}button{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}legend{color:inherit;display:table;max-width:100%;white-space:normal}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[hidden]{display:none}html{box-sizing:border-box;font-family:sans-serif}*,:after,:before{box-sizing:inherit}blockquote,h1,h2,h3,h4,p,pre{margin:0}button{background:transparent;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{margin:0}*,:after,:before{border:0 solid #dae1e7}img{border-style:solid;max-width:100%;height:auto}input::-webkit-input-placeholder{color:inherit;opacity:.5}input::-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}.container{width:100%}@media (min-width:576px){.container{max-width:576px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:992px){.container{max-width:992px}}@media (min-width:1200px){.container{max-width:1200px}}.list-reset{list-style:none;padding:0}.bg-black{background-color:#22292f}.bg-white{background-color:#fff}.bg-green-lighter{background-color:#d9f1e3}.bg-blue-darker{background-color:#20303a}.bg-blue{background-color:#3490dc}.hover\:bg-blue-dark:hover{background-color:#2779bd}.border-green{border-color:#24d06b}.border-green-lighter{border-color:#d9f1e3}.border-green-lightest{border-color:#3efc9c}.focus\:border-grey-light:focus{border-color:#dae1e7}.rounded{border-radius:.25rem}.rounded-lg{border-radius:1.125rem}.rounded-full{border-radius:9999px}.rounded-t-lg{border-top-left-radius:1.125rem;border-top-right-radius:1.125rem}.border{border-width:1px}.border-t-2{border-top-width:2px}.border-t-4{border-top-width:4px}.border-l-8{border-left-width:8px}.block{display:block}.inline-block{display:inline-block}.table{display:table}.hidden{display:none}.flex{display:flex}.inline-flex{display:inline-flex}.flex-col{flex-direction:column}.flex-col-reverse{flex-direction:column-reverse}.items-center{align-items:center}.items-stretch{align-items:stretch}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.content-end{align-content:flex-end}.flex-1{flex:1 1 0%}.flex-no-shrink{flex-shrink:0}.font-sans{font-family:system-ui,BlinkMacSystemFont,-apple-system,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif}.font-semibold{font-weight:600}.font-bold{font-weight:700}.h-4{height:1rem}.h-6{height:1.5rem}.h-16{height:4rem}.h-32{height:8rem}.h-48{height:12rem}.h-full{height:100%}.leading-tight{line-height:1.25}.mx-4{margin-left:1rem;margin-right:1rem}.mx-5{margin-left:1.25rem;margin-right:1.25rem}.my-8{margin-top:2rem;margin-bottom:2rem}.mx-auto{margin-left:auto;margin-right:auto}.ml-0{margin-left:0}.mb-1{margin-bottom:.25rem}.mt-2{margin-top:.5rem}.ml-2{margin-left:.5rem}.mb-3{margin-bottom:.75rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-4{margin-bottom:1rem}.ml-4{margin-left:1rem}.mt-5{margin-top:1.25rem}.mb-5{margin-bottom:1.25rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mb-8{margin-bottom:2rem}.ml-8{margin-left:2rem}.mt-16{margin-top:4rem}.mb-24{margin-bottom:6rem}.mr-32{margin-right:8rem}.mb-32{margin-bottom:8rem}.ml-32{margin-left:8rem}.mb-auto{margin-bottom:auto}.max-h-full{max-height:100%}.max-w-xs{max-width:20rem}.max-w-md{max-width:40rem}.max-w-lg{max-width:50rem}.min-h-full{min-height:100%}.-mb-1{margin-bottom:-.25rem}.-ml-8{margin-left:-2rem}.-mt-16{margin-top:-4rem}.-mt-32{margin-top:-8rem}.-mr-32{margin-right:-8rem}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-hidden{overflow-y:hidden}.p-1{padding:.25rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.px-8{padding-left:2rem;padding-right:2rem}.pl-4{padding-left:1rem}.pt-6{padding-top:1.5rem}.pl-8{padding-left:2rem}.pr-10{padding-right:2.5rem}.pb-12{padding-bottom:3rem}.pb-32{padding-bottom:8rem}.absolute{position:absolute}.relative{position:relative}.pin{top:0;bottom:0;left:0}.pin,.pin-r{right:0}.pin-b{bottom:0}.pin-l{left:0}.shadow-md{box-shadow:0 4px 8px 0 rgba(0,0,0,.12),0 2px 4px 0 rgba(0,0,0,.08)}.fill-current{fill:currentColor}.stroke-current{stroke:currentColor}.text-grey-darkest{color:#3d4852}.text-grey-dark{color:#8795a1}.text-white{color:#fff}.text-green{color:#24d06b}.text-green-lighter{color:#d9f1e3}.text-blue-darker{color:#20303a}.hover\:text-green:hover{color:#24d06b}.text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-md{font-size:.9375rem}.text-base{font-size:1rem}.text-lg{font-size:1.125rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.text-4xl{font-size:2.25rem}.text-5xl{font-size:3rem}.uppercase{text-transform:uppercase}.no-underline{text-decoration:none}.tracking-wide{letter-spacing:.05em}.w-4{width:1rem}.w-6{width:1.5rem}.w-24{width:6rem}.w-48{width:12rem}.w-64{width:16rem}.w-auto{width:auto}.w-full{width:100%}.z-0{z-index:0}.z-10{z-index:10}#___gatsby,#___gatsby>div,body,html{width:100%;height:100%}@media (min-width:768px){.md\:mx-0{margin-left:0;margin-right:0}.md\:mt-0{margin-top:0}.md\:mr-0{margin-right:0}.md\:ml-0{margin-left:0}.md\:mt-8{margin-top:2rem}.md\:mt-16{margin-top:4rem}.md\:-ml-16{margin-left:-4rem}.md\:px-0{padding-left:0;padding-right:0}.md\:px-10{padding-left:2.5rem;padding-right:2.5rem}.md\:text-5xl{font-size:3rem}}@media (min-width:992px){.lg\:block{display:block}.lg\:flex{display:flex}.lg\:flex-row{flex-direction:row}.lg\:flex-row-reverse{flex-direction:row-reverse}.lg\:ml-0{margin-left:0}.lg\:ml-8{margin-left:2rem}.lg\:-mr-32{margin-right:-8rem}.lg\:-ml-32{margin-left:-8rem}.lg\:pl-23{padding-left:5.625rem}.lg\:w-3\/4{width:75%}}@media (min-width:1200px){.xl\:w-4\/5{width:80%}}</style><meta name="generator" content="Gatsby 2.0.73"/><link rel="manifest" href="/xi-editor-gatsby/manifest.webmanifest"/><title data-react-helmet="true">CRDT - An approach to async plugins and undo | Xi</title><link data-react-helmet="true" rel="icon" type="image/png" sizes="32x32" href="/xi-editor-gatsby/logos/favicon-32x32.png"/><link data-react-helmet="true" rel="icon" type="image/png" sizes="16x16" href="/xi-editor-gatsby/logos/favicon-16x16.png"/><link data-react-helmet="true" rel="mask-icon" href="/xi-editor-gatsby/logos/safari-pinned-tab.svg" color="#24d06b"/><link data-react-helmet="true" rel="shortcut icon" href="favicon.ico"/><link data-react-helmet="true" rel="apple-touch-icon" href="/xi-editor-gatsby/logos/apple-touch-icon.png"/><meta data-react-helmet="true" name="msapplication-TileColor"/><meta data-react-helmet="true" name="msapplication-config" content="browserconfig.xml"/><meta data-react-helmet="true" name="description" content="A primary goal of the xi project is to provide extremely fast responsiveness in all circumstances. For core editing operations, this can generally be accomplished by extremely fast implementation of the editing primitives. However, non-responsiveness due to plugins is a very significant problem, andâ€¦"/><meta data-react-helmet="true" name="image" content="https://elod10.github.io/xi-editor-gatsby/logos/logo.png"/><meta data-react-helmet="true" property="al:ios:url" content="nflx://www.netflix.com/?locale=fr-FR"/><meta data-react-helmet="true" property="al:android:app_name" content="Xi"/><meta data-react-helmet="true" property="al:android:url" content="https://elod10.github.io"/><meta data-react-helmet="true" name="apple-mobile-web-app-capable" content="yes"/><meta data-react-helmet="true" property="og:title" content="Xi"/><meta data-react-helmet="true" property="og:description" content="Xi-Editor website"/><meta data-react-helmet="true" property="og:image" content="https://elod10.github.io/xi-editor-gatsby/logos/logo.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Xi"/><meta data-react-helmet="true" name="twitter:description" content="Xi-Editor website"/><meta data-react-helmet="true" name="twitter:image" content="https://elod10.github.io/xi-editor-gatsby/logos/logo.png"/><link rel="sitemap" type="application/xml" href="/xi-editor-gatsby/sitemap.xml"/><link as="script" rel="preload" href="/xi-editor-gatsby/1-6e57b76f82a78bcb777f.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/component---cache-gatsby-mdx-mdx-wrappers-dir-6-a-6-d-7612520-aff-73-cb-56-c-0-b-39-c-2-af-0-be-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js-96b730ebcfd9805849e8.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/app-46f25a4e0bb303c5d58f.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/0-3058d9943b60ad518acf.js"/><link as="script" rel="preload" href="/xi-editor-gatsby/webpack-runtime-8f000ca1e32cbe792686.js"/><link as="fetch" rel="preload" href="/xi-editor-gatsby/static/d/506/path---documentation-crdt-2-b-0-63f-1bEXb8H2n7f2rAcanGNGaaK8fGY.json" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="h-full w-full flex flex-col items-stretch font-sans"><header class="flex flex-col flex-no-shrink border-t-2 border-green h-16 mb-32"><div class="bg-white"><div class="container mx-auto"><div class="flex justify-between items-center py-4"><div class="flex items-center"><a class="text-white no-underline flex items-center ml-2 md:ml-0" href="/xi-editor-gatsby/"><p class="font-bold text-4xl text-blue-darker">Xi</p></a></div><div class="flex justify-between overflow-x-auto overflow-y-hidden mx-4 md:mx-0"><a class="flex items-center no-underline text-base uppercase text-blue-darker mx-5 font-semibold witespace-no-wrap" href="/xi-editor-gatsby/">home</a><a class="flex items-center no-underline text-base uppercase text-blue-darker mx-5 font-semibold witespace-no-wrap" href="/xi-editor-gatsby/documentation/frontend-notes/">docs</a><a class="flex items-center no-underline text-base uppercase text-blue-darker mx-5 font-semibold witespace-no-wrap" href="/xi-editor-gatsby/gsoc/gsoc/">gsoc</a><a class="flex items-center no-underline text-base uppercase text-blue-darker mx-5 font-semibold witespace-no-wrap" href="/xi-editor-gatsby/contribute/">contribute</a><a class="flex items-center no-underline text-base uppercase text-blue-darker mx-5 font-semibold witespace-no-wrap" href="/xi-editor-gatsby/building-docs/">buildind docs</a><a class="flex items-center no-underline text-base uppercase text-blue-darker mx-5 font-semibold witespace-no-wrap" href="/xi-editor-gatsby/blog">blog</a></div></div></div></div></header><main role="main" class="flex-1 -mt-32"><div class="flex"><div class="w-64"><nav class="pt-6 max-w-xs w-auto pb-32"><ul class="list-reset flex flex-col flex-1"><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/frontend-notes/">Notes on writing front-ends</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/frontend-protocol/">The Frontend Protocol</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/plugin/">Plugin architecture</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/config/">Working with the config system</a></li><li class="leading-tight max-x-xs"><a aria-current="page" class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md font-semibold border-l-8 border-green-lightest" href="/xi-editor-gatsby/documentation/crdt/">CRDT - An approach to async plugins and undo</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/crdt-details/">CRDT - The Xi Text Engine</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/fuchsia-ledger-crdts/">CRDT - Using the Ledger for CRDTs</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-00/">Rope science - Introduction</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-01/">Rope science, part 1 - MapReduce for text</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-02/">Rope science, part 2 - metrics</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-03/">Rope science, part 3 - Grapheme cluster boundaries</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-04/">Rope science, part 4 - parenthesis matching</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-05/">Rope science, part 5 - incremental word wrapping</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-06/">Rope science, part 6 - parallel and asynchronous word wrapping</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-08/">Rope science, part 8 - CRDTs for concurrent editing</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-09/">Rope science, part 9 - CRDT Approach to Async Plugins and Undo</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-10/">Rope science, part 10 - designing for a conflict-free world</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-11/">Rope science, part 11 - practical syntax highlighting</a></li><li class="leading-tight max-x-xs"><a class="block text-md px-6 py-2 text-blue-darker no-underline hover:text-green rounded-md" href="/xi-editor-gatsby/documentation/rope-science-12/">Rope science, part 12 - minimal invalidation</a></li></ul></nav></div><div class="max-w-lg px-2 md:px-10 py-8 mb-24 content mx-auto lg:ml-8 overflow-hidden"><div class="lg:w-3/4 xl:w-4/5"><h1 class="ml-4 lg:ml-0 text-blue-darker mt-8 mb-4">CRDT - An approach to async plugins and undo</h1><div><div><p>A primary goal of the xi project is to provide extremely fast responsiveness in all circumstances. For core editing operations, this can generally be accomplished by extremely fast implementation of the editing primitives. However, non-responsiveness due to plugins is a very significant problem, and just making faster plugins is not an appealing solution; we want plugins to do sophisticated lexical and syntactical analysis so their operations can be accurate.</p><p>Other editor projects recognize delays due to plugins and propose to run the plugins asynchronously. <a href="https://github.com/neovim/neovim/wiki/Plugin-UI-architecture" target="_blank" rel="nofollow noopener noreferrer">Neovim</a> is probably the most advanced in this regard. However, simply running the editing operations asynchronously carries its own risk: the user and the plugin (or perhaps multiple plugins) are <em>racing,</em> and the final editing result can depend on the order of execution.</p><p>This problem is fundamentally similar to collaborative editing, and there is a literature spanning decades. Some of the approaches, such as <a href="https://en.wikipedia.org/wiki/Operational_transformation" target="_blank" rel="nofollow noopener noreferrer">operational transformation</a>, are fiendishly difficult to implement correctly, and seem like overkill for a primarily single-user text editor. However, in recent years, the Conflict-free Replicated Data Type (CRDT) approach has emerged, and I believe it is well suited for xi. In particular, I believe a centralized CRDT implementation in the core can be implemented with only a bit more complexity than required for undo and running plugins asynchronously, and yet provide strong eventual consistency guarantees characteristic of CRDTs.</p><p>In addition, should xi ever be extended to collaborative editing, having the model be based on the CRDT abstraction will make implementation much easier, leaving only the small matter of efficient distributed CRDTs themselves.</p><p>This document is structured into two main sections. The first presents the model at a conceptual level, and effectively functions as a spec for how out-of-order edits should be merged, as well as the desired semantics for undo. The second details a simple and efficient centralized implementation, which faithfully implements the model but bypasses the complexity of a true distributed environment.</p><h2 id="CRDT-model"><a href="#CRDT-model" aria-hidden="true" class="anchor"></a>CRDT model</h2><p>The document consists of a collection of characters, each of which has a stable unique id. In addition, there are <em>ordering edges</em> between pairs of characters. For example, if the document is &quot;AB&quot; and the user inserts an &quot;X&quot; between these two characters, the ordering edges A &lt; X and X &lt; B are generated. Two special id&#x27;s represent the beginning and end of the document.</p><p>If only a single user were editing the document, then these edges would form a total order. However, in the face of concurrent edits, they are in general only a partial order. For example, if another user inserts &quot;Y&quot; at the same location, then the additional edges A &lt; Y and Y &lt; B are generated, but there is no order between X and Y. In this case, we define tie-breaking rules based on an integer id of each user. For example, assume the first user has the lower id. Then, with the edits applied in either order, the result will consistently be &quot;AXYB&quot;. This approach follows WOOT.</p><h3 id="Deletion-tombstones-intervals"><a href="#Deletion-tombstones-intervals" aria-hidden="true" class="anchor"></a>Deletion; tombstones; intervals</h3><p>In a CRDT framework, the user action of deleting a character doesn&#x27;t remove it from the graph, it simply marks it as deleted. Thus, the merge operation forms a monotonic semi-lattice; the union of new characters and ordering edges, and the &quot;or&quot; of delete state for the character.</p><p>A deleted character is known as a &quot;tombstone&quot;, and these have also been used to patch up operational transformations to fix the failure to achieve eventual consistency (this is known in the literature as the TP2 puzzle and is well explained in the tombstone paper referenced below). Retaining tombstones doubly makes sense in an editor because there is a chance the deletion will be undone, so retaining it guarantees that its order relative to its context is preserved.</p><h3 id="Undo"><a href="#Undo" aria-hidden="true" class="anchor"></a>Undo</h3><p>Defining the semantics of undo is tricky, especially in the face of concurrent edits, and a lot of ink has been spilled on the subject. Here we present a simple but general model again based on CRDT.</p><p>Each editing operation is assigned an &quot;undo group.&quot; Several edits may be in the same group. For example, if the user types <code>&quot;</code>, then a smart-quote plugin may revise that to &#x27;â€œ&#x27;. If the smart-quote revision is assigned the same undo group (because it is a consequence of the same user action), then a single undo would zorch both edits. Note, incidentally, that TextEdit on macOS does not exhibit this behavior. The first undo leaves the buffer with &#x27;&quot;&#x27; (and selected), and it requires a second undo to return to the initial contents.</p><p>Each edit has <em>two</em> sets characters, one for deletions (as above), but also for insertions. In normal editing, the insertion set is ignored. However, when an undo group goes into an undone state, the insertion and deletion sets are swapped. Note that if a character is both inserted and deleted by edits in the same undo group (as is the case for the poor dumb quote above), its state does not change.</p><p>Note that the mechanism allows for selective undo of any undo group. We probably won&#x27;t expose this generality through the UI, but rather provide the familiar ctrl-z, shift-ctrl-z keybindings. However, undoing complex edits interleaved with others (because of slow plugins) will call upon this generality.</p><p>I&#x27;m not overly concerned with concurrent modification to undo state, as it will be managed by the central core, but it&#x27;s still straightforward to handle as a CRDT. Each undo group gets a distributed counter, and the group is considered to be undone when the counter is odd-valued.</p><h3 id="Recap"><a href="#Recap" aria-hidden="true" class="anchor"></a>Recap</h3><p>It&#x27;s worth recapping the end-to-end flow, because it&#x27;s not obvious. Reconstructing the visible buffer contents from the CRDT state will be described as a batch operation. Obviously we want to compute that incrementally, but implementation details add complexity and are very different depending on whether it is centralized or distributed.</p><p>The CRDT state is:</p><ul><li><p>A set of characters, each given by stable unique id (and for which two id&#x27;s can be compared for tie-breaking purposes).</p></li><li><p>A set of ordering edges, each of which is a pair of ids.</p></li><li><p>A set of edits, each of which consists of:</p><ul><li><p>An undo group id.</p></li><li><p>A set of deleted characters.</p></li><li><p>A set of inserted characters.</p></li></ul></li></ul><p>These are all basically sets, so the CRDT merge operation is just set union of each of these components.</p><p>To reconstruct the buffer:</p><ul><li><p>Topologically sort the characters by ordering edges and tiebreaks, yielding a sequence.</p></li><li><p>Decide for each edit group whether it is in an undo state, either centrally or by taking the parity of its associated counter.</p></li><li><p>For each edit, if its edit group is in an undone state, add its inserted characters, otherwise add its deleted characters.</p></li><li><p>Take the union of all characters from the previous step, and delete those from the sequence.</p></li></ul><p>Et voila!</p><h2 id="Efficient-implementation"><a href="#Efficient-implementation" aria-hidden="true" class="anchor"></a>Efficient implementation</h2><p>Details to come later, but I&#x27;ll try to sketch out rough ideas.</p><p>In xi, we&#x27;re not setting out to do a fully distributed peer-to-peer CRDT implementation (though such a thing would be a very interesting future extension). Rather, we want to exploit the assumption that the core is fast and reliable, and have it evaluate the CRDT efficiently and incrementally, but in serial.</p><p>Instead of storing the CRDT components explicitly, we store a sequence of <em>snapshots.</em> Following the CRDT model, each snapshot contains the &quot;union string&quot; (the result of the topological sort, with deleted sections still present). However, we don&#x27;t store explicit unique ids for each character, or explicit ordering edges. Rather, the total order (with tie-breaking applied) is preserved in each snapshot.</p><p>Because we don&#x27;t have explicit unique id&#x27;s, we simulate them by doing <em>coordinate transforms.</em> This is fairly straightforward because the only difference between the union strings in two different snapshots is intervals of inserted characters. In fact, we can probably re-use the &quot;insert intervals&quot; retained for undo purposes as the concrete representation of the needed coordinate transforms.</p><p>The coordinate transform approach has an operational transform flavor, but it is important to note, the goal is still to implement exactly the same CRDT computation as specified in the first section.</p><p>We don&#x27;t retain all snapshots going back to the beginning of history, nor do we retain all tombstones indefinitely. Rather, we <em>garbage collect</em> a snapshot as soon as it is no longer needed (because it expired out of the undo buffer and we are sure its undo state will not toggle, and because it is not used as the base of any in-flight plugin operation). Garbage collection also removes deleted intervals when there is no possible future reference to them.</p><p>In the general case, undo requires going back to an earlier snapshot (the latest one that doesn&#x27;t contain any edits from the undo group being toggled), and replaying the history from there. Because of this and the need for garbage collection, the undo history will be bounded rather than infinite (20 steps seems reasonable).</p><h2 id="References"><a href="#References" aria-hidden="true" class="anchor"></a>References</h2><p><a href="https://hal.archives-ouvertes.fr/inria-00432373/document" target="_blank" rel="nofollow noopener noreferrer">An Undo Framework for P2P Collaborative Editing</a></p><p><a href="http://www.loria.fr/~urso/uploads/Main/oster06collcom.pdf" target="_blank" rel="nofollow noopener noreferrer">Tombstone Transformation Functions for Ensuring Consistency in Collaborative Editing Systems</a></p><p><a href="https://hal.inria.fr/inria-00071240/document" target="_blank" rel="nofollow noopener noreferrer">Real time group editors without Operational transformation</a> (WOOT)</p><p><a href="http://hal.upmc.fr/inria-00555588/document" target="_blank" rel="nofollow noopener noreferrer">A comprehensive study of Convergent and Commutative Replicated Data Types</a></p></div></div></div></div></div></main></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---cache-gatsby-mdx-mdx-wrappers-dir-6-a-6-d-7612520-aff-73-cb-56-c-0-b-39-c-2-af-0-be-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js","jsonName":"documentation-crdt-2b0","path":"/documentation/crdt/"};window.dataPath="506/path---documentation-crdt-2-b-0-63f-1bEXb8H2n7f2rAcanGNGaaK8fGY";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-46f25a4e0bb303c5d58f.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-5bf3dc2c26ecbd63fbd0.js"],"component---src-templates-blog-list-js":["/component---src-templates-blog-list-js-68e29daae0f560473896.js"],"component---cache-gatsby-mdx-mdx-wrappers-dir-d-95-ab-767-d-696-bb-926-c-5-d-1-d-8-ce-389204-d-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js":["/component---cache-gatsby-mdx-mdx-wrappers-dir-d-95-ab-767-d-696-bb-926-c-5-d-1-d-8-ce-389204-d-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js-3cce64ab6ad8a00f8053.js"],"component---cache-gatsby-mdx-mdx-wrappers-dir-6-a-6-d-7612520-aff-73-cb-56-c-0-b-39-c-2-af-0-be-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js":["/component---cache-gatsby-mdx-mdx-wrappers-dir-6-a-6-d-7612520-aff-73-cb-56-c-0-b-39-c-2-af-0-be-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js-96b730ebcfd9805849e8.js"],"component---cache-gatsby-mdx-mdx-wrappers-dir-248-e-51405-d-8-ad-0-e-8-ff-1-a-314-a-5-b-224-cc-0-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js":["/component---cache-gatsby-mdx-mdx-wrappers-dir-248-e-51405-d-8-ad-0-e-8-ff-1-a-314-a-5-b-224-cc-0-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js-b8d3395483f2c4f148de.js"],"component---src-pages-404-js":["/component---src-pages-404-js-db6cd2ae89009ad1afcd.js"],"component---src-pages-building-docs-js":["/component---src-pages-building-docs-js-d39a25107e95f1a6f7cc.js"],"component---src-pages-contribute-js":["/component---src-pages-contribute-js-c18274c924e984ba4a11.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b6c47ee8616466477674.js"]};/*]]>*/</script><script src="/xi-editor-gatsby/webpack-runtime-8f000ca1e32cbe792686.js" async=""></script><script src="/xi-editor-gatsby/0-3058d9943b60ad518acf.js" async=""></script><script src="/xi-editor-gatsby/app-46f25a4e0bb303c5d58f.js" async=""></script><script src="/xi-editor-gatsby/component---cache-gatsby-mdx-mdx-wrappers-dir-6-a-6-d-7612520-aff-73-cb-56-c-0-b-39-c-2-af-0-be-scope-hash-3010-b-3-badc-54-a-9-dfa-4-a-4-c-80-e-419-a-41-b-2-js-96b730ebcfd9805849e8.js" async=""></script><script src="/xi-editor-gatsby/1-6e57b76f82a78bcb777f.js" async=""></script></body></html>